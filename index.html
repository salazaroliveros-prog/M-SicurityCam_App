<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- PWA Config -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- meta theme-color eliminado para compatibilidad total -->
    <!-- Nota: 'theme-color' no es soportado por Firefox, Opera. Se mantiene para Chrome/Edge. -->
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3064/3064197.png" />

    <title>M&S Security Cam Ultra</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3064/3064197.png"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.10/hls.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
  

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;400;700&display=swap');

        body {
            background: #000;
            color: #fff;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }

        /* Pantalla 1: Fluido Visual */
        .fluid-bg {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a2e, #000);
            z-index: 0;
        }
        .color-twist {
            position: absolute; width: 200%; height: 200%;
            top: -50%; left: -50%;
            background: conic-gradient(from 0deg, transparent, rgba(255,0,100,0.2), rgba(0,255,200,0.2), rgba(255,215,0,0.2), transparent);
            filter: blur(60px);
            animation: twist 30s linear infinite;
        }
        @keyframes twist { 
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .rec-frame {
            position: absolute; inset: 10%;
            border: 2px solid rgba(255,255,255,0.1);
            z-index: 10;
            pointer-events: none;
            animation: rec-pulse 5s infinite ease-in-out;
            -webkit-backdrop-filter: blur(0px);
            backdrop-filter: blur(0px);
        }
        @keyframes rec-pulse {
            0%, 100% { transform: scale(0.9); -webkit-backdrop-filter: blur(0px); backdrop-filter: blur(0px); }
            50% { transform: scale(1.1); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); }
        }

        .dot-blink, .dot-rec {
            width: 8px; height: 8px; background: #22c55e;
            border-radius: 50%; display: inline-block;
            box-shadow: 0 0 10px #22c55e;
            animation: blink 1s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        .btn-gold {
            background: linear-gradient(to bottom, #FFD700, #B8860B);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            transition: 0.3s;
        }
        .btn-gold:active { transform: scale(0.9); }

        /* Monitor Layout */
        .monitor-grid {
            display: grid;
            gap: 8px;
            padding: 8px;
            height: calc(100% - 160px);
            overflow-y: auto;
        }
        .cam-slot {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            aspect-ratio: 16/9;
        }
        .cam-slot.focused {
            position: fixed;
            inset: 0;
            z-index: 100;
            width: 100%;
            height: 100%;
            border-radius: 0;
        }

        .decryption-log {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #22c55e;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 10px;
            height: 80px;
            overflow-y: hidden;
        }
    </style>
</head>
<body>

<div id="app"></div>

<script>
    // --- ESTADO ---
    const DB_KEY = 'ms_cam_ultra_v7';
    let state = {
        phase: 'splash', // splash, vinculacion, monitor
        config: JSON.parse(localStorage.getItem(DB_KEY)) || {
            password: '',
            cams: []
        },
        scanning: false,
        decrypted: false,
        tempUrl: '',
        logLines: []
    };

    const save = () => localStorage.setItem(DB_KEY, JSON.stringify(state.config));
    function clearAll() {
        if (confirm('¬øSeguro que deseas borrar toda la configuraci√≥n y c√°maras?')) {
            localStorage.removeItem(DB_KEY);
            state.config = { password: '', cams: [] };
            state.phase = 'splash';
            render();
        }
    }

    // --- NAVEGACI√ìN ---
    function setPhase(p) {
        state.phase = p;
        render();
    }

    // --- ACCESO Y SEGURIDAD ---
    function handleAccess() {
        if (state.config.password) {
            const p = prompt("ACCESO RESTRINGIDO. Ingrese contrase√±a:");
            if (p === state.config.password) setPhase('vinculacion');
            else if (p !== null) alert("Error de credenciales.");
        } else {
            setPhase('vinculacion');
        }
    }

    function toggleSecurity() {
        const p = prompt("Cree una contrase√±a para proteger sus transmisiones (Deje en blanco para eliminar):", "");
        if (p !== null) {
            state.config.password = p;
            save();
            render();
        }
    }

    // --- L√ìGICA DE SE√ëAL ---
    const logPool = [
        "Iniciando escaneo de radiofrecuencia...",
        "Analizando latencia en puerto 554...",
        "Paquetes RTSP detectados...",
        "Descifrando cabeceras de flujo...",
        "Interferencia filtrada. Se√±al estable.",
        "Nodo identificado correctamente."
    ];

    function runSignalScan() {
        state.scanning = true;
        state.logLines = [];
        render();
        
        let i = 0;
        const interval = setInterval(() => {
            if (i < logPool.length) {
                state.logLines.push("> " + logPool[i]);
                i++;
                render();
            } else {
                clearInterval(interval);
                state.scanning = false;
                state.decrypted = true;
                render();
            }
        }, 800);
    }

    function isValidUrl(url) {
        try {
            new URL(url);
            return true;
        } catch {
            return false;
        }
    }
    function addCam() {
        const input = document.getElementById('urlInput');
        const url = (input ? input.value : '') || state.tempUrl;
        const feedback = document.getElementById('feedback-msg');
        if (!url) {
            if (feedback) { feedback.innerText = 'Debes ingresar una URL.'; feedback.classList.remove('hidden'); }
            return;
        }
        if (!isValidUrl(url)) {
            if (feedback) { feedback.innerText = 'La URL ingresada no es v√°lida.'; feedback.classList.remove('hidden'); }
            return;
        }
        if (state.config.cams.length >= 5) {
            if (feedback) { feedback.innerText = 'Solo puedes agregar hasta 5 c√°maras.'; feedback.classList.remove('hidden'); }
            return;
        }
        state.config.cams.push({ url, id: Date.now() });
        save();
        state.decrypted = false;
        state.tempUrl = '';
        if (feedback) feedback.classList.add('hidden');
        render();
    }

    function removeCam(id) {
        state.config.cams = state.config.cams.filter(c => c.id !== id);
        save();
        render();
    }

    // --- RENDERIZADO ---
    function render() {
        const root = document.getElementById('app');
        if (!root) return;

        // PANTALLA 1: SPLASH
        if (state.phase === 'splash') {
            root.innerHTML = `
                <div class="relative h-screen flex flex-col items-center justify-center p-8 text-center overflow-hidden">
                    <div class="fluid-bg"><div class="color-twist"></div></div>
                    <div class="rec-frame"></div>
                    <div class="relative z-20">
                        <div class="mb-4"><span class="dot-rec"></span></div>
                        <h1 class="text-8xl font-black font-orbitron text-white leading-none">M&S</h1>
                        <h2 class="text-lg font-light tracking-[0.5em] text-slate-400 mt-2 uppercase">Security Cam</h2>
                        <div class="mt-24">
                            <button onclick="handleAccess()" class="btn-gold text-black font-black px-12 py-5 rounded-2xl text-xs uppercase tracking-widest shadow-2xl">
                                Acceso a M&S Cam
                            </button>
                        </div>
                    </div>
                    <div class="absolute bottom-10 w-full text-[10px] text-slate-600 font-bold uppercase tracking-[0.4em]">
                        comprometidos con la transparencia
                    </div>
                </div>
            `;
        }

        // PANTALLA 2: VINCULACI√ìN
        else if (state.phase === 'vinculacion') {
            root.innerHTML = `
                <div class="h-screen bg-slate-950 p-6 flex flex-col no-scrollbar overflow-y-auto">
                    <div class="flex justify-between items-center mb-8 pt-4">
                        <h2 class="text-2xl font-orbitron font-black uppercase">Vincular</h2>
                        <div class="flex gap-2">
                            <button onclick="toggleSecurity()" class="p-2 bg-slate-900 rounded-lg border border-white/5" aria-label="Contrase√±a">
                                ${state.config.password ? 'üîí' : 'üîì'}
                            </button>
                            <button onclick="clearAll()" class="p-2 bg-slate-900 rounded-lg border border-white/5 text-red-500" aria-label="Borrar todo" title="Borrar todo">üóëÔ∏è</button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Slots -->
                        <div class="grid grid-cols-2 gap-3">
                            ${state.config.cams.map((c, i) => `
                                <div class="aspect-video bg-blue-900/10 border border-blue-500/20 rounded-xl flex flex-col items-center justify-center relative">
                                    <span class="text-[9px] font-bold text-blue-400">NODO 0${i+1}</span>
                                    <button onclick="removeCam(${c.id})" class="absolute top-2 right-2 text-red-500 text-[10px]" aria-label="Eliminar">‚úï</button>
                                </div>
                            `).join('')}
                            ${state.config.cams.length < 5 ? `
                                <div class="aspect-video border-2 border-dashed border-slate-800 rounded-xl flex items-center justify-center text-slate-800">+</div>
                            ` : ''}
                        </div>

                        <!-- Panel de Se√±al -->
                        <div class="bg-slate-900/50 p-6 rounded-3xl border border-white/5 space-y-4">
                            <div class="decryption-log" aria-live="polite">
                                ${state.logLines.length > 0 ? state.logLines.join('<br>') : '> ESPERANDO SE√ëAL...'}
                            </div>
                            <input id="urlInput" placeholder="URL o IP de la C√°mara" class="w-full bg-black border border-slate-800 p-4 rounded-xl text-xs font-mono text-yellow-500 outline-none focus:border-yellow-500" value="${state.tempUrl}" aria-label="URL de la c√°mara">
                            <div id="feedback-msg" class="text-red-500 text-xs hidden"></div>
                            <div class="flex gap-2">
                                <button onclick="runSignalScan()" class="flex-1 bg-slate-800 py-4 rounded-xl text-[10px] font-black uppercase tracking-widest active:bg-slate-700" aria-label="Buscar se√±al">
                                    ${state.scanning ? 'DESCIFRANDO...' : 'BUSCAR SE√ëAL'}
                                </button>
                                <button onclick="openQrScanner()" class="w-14 bg-slate-800 rounded-xl flex items-center justify-center" aria-label="Escanear QR">üì∑</button>
                            </div>

                            ${state.decrypted ? `
                                <div class="pt-4 animate-pulse">
                                    <button onclick="addCam()" class="w-full bg-green-600 py-5 rounded-2xl font-black uppercase tracking-widest text-xs">ACCEDE</button>
                                    <p class="text-center text-[8px] text-green-500 uppercase mt-2 tracking-widest">a observar el mundo</p>
                                </div>
                            ` : ''}
                        </div>

                        ${state.config.cams.length > 0 ? `
                            <button onclick="setPhase('monitor')" class="w-full bg-yellow-500 text-black py-5 rounded-2xl font-black uppercase text-xs shadow-xl">ENTRAR AL PANEL</button>
                        ` : ''}

                        <button onclick="alert('Copiado enlace de instalaci√≥n.')" class="w-full text-slate-600 text-[10px] uppercase font-bold py-4">Compartir Link de Instalaci√≥n</button>
                    </div>
                </div>
            `;
            // Accesibilidad: enfocar input
            setTimeout(() => {
                const input = document.getElementById('urlInput');
                if (input) input.focus();
            }, 100);
        }
    // QR Scanner funcional dentro de render()
    window.openQrScanner = function() {
        const qrDiv = document.createElement('div');
        qrDiv.id = 'qr-modal';
        qrDiv.className = 'fixed inset-0 bg-black/80 flex flex-col items-center justify-center z-[9999]';
        qrDiv.innerHTML = `
            <div class="bg-slate-900 p-6 rounded-2xl flex flex-col items-center">
                <div id="qr-reader" style="width:300px;"></div>
                <button onclick="closeQrScanner()" class="mt-4 bg-red-600 text-white px-6 py-2 rounded-xl">Cerrar</button>
            </div>
        `;
        document.body.appendChild(qrDiv);
        const qr = new Html5Qrcode("qr-reader");
        qr.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
            (decodedText) => {
                document.getElementById('urlInput').value = decodedText;
                qr.stop().then(() => window.closeQrScanner());
            },
            () => {}
        );
        window._qrInstance = qr;
    }
    window.closeQrScanner = function() {
        if (window._qrInstance) window._qrInstance.stop();
        const qrDiv = document.getElementById('qr-modal');
        if (qrDiv) qrDiv.remove();
    }

        // PANTALLA 3: MONITOR
        if (state.phase === 'monitor') {
            const count = state.config.cams.length;
            const gridClass = count === 1 ? 'grid-cols-1' : (count === 2 ? 'grid-cols-2' : 'grid-cols-2');

            root.innerHTML = `
                <div class="h-screen bg-black flex flex-col">
                    <div class="p-5 flex justify-between items-center bg-slate-950 border-b border-white/5">
                        <span class="text-[10px] font-orbitron font-black text-yellow-500 tracking-widest">M&S LIVE ‚Ä¢ ${count} NODOS</span>
                        <button onclick="setPhase('splash')" class="text-[9px] font-black text-red-500 uppercase">SALIR</button>
                    </div>

                    <div class="monitor-grid ${gridClass} flex-1 no-scrollbar">
                        ${state.config.cams.map((c, i) => `
                            <div class="cam-slot" onclick="this.classList.toggle('focused')">
                                <video id="vid-${i}" class="w-full h-full object-cover" muted playsinline autoplay></video>
                                <div class="absolute top-2 left-2 bg-black/60 px-2 py-1 rounded text-[8px] font-bold">NODO 0${i+1}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="p-6 bg-slate-900 border-t border-white/10 rounded-t-[40px] shadow-2xl">
                        <div class="flex justify-around items-center">
                            <button onclick="alert('Captura guardada en almacenamiento local.')" class="w-14 h-14 bg-slate-800 rounded-full flex items-center justify-center border border-white/10">üì∏</button>
                            
                            <div class="grid grid-cols-3 gap-1 bg-black/40 p-2 rounded-2xl border border-white/5">
                                <div></div><button class="w-8 h-8 bg-slate-800 rounded flex items-center justify-center text-[10px]">‚ñ≤</button><div></div>
                                <button class="w-8 h-8 bg-slate-800 rounded flex items-center justify-center text-[10px]">‚óÄ</button>
                                <button class="w-8 h-8 bg-white text-black font-black rounded flex items-center justify-center text-[8px]">OK</button>
                                <button class="w-8 h-8 bg-slate-800 rounded flex items-center justify-center text-[10px]">‚ñ∂</button>
                                <div></div><button class="w-8 h-8 bg-slate-800 rounded flex items-center justify-center text-[10px]">‚ñº</button><div></div>
                            </div>

                            <button onclick="alert('Descargando buffer temporal del dispositivo...')" class="bg-blue-600 px-6 py-3 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg">DESCARGAR</button>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(initStreams, 100);
        }
    }

    function initStreams() {
        state.config.cams.forEach((c, i) => {
            const video = document.getElementById(`vid-${i}`);
            if (!video) return;
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(c.url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = c.url;
            }
        });
    }

    render();
</script>
</body>
</html>